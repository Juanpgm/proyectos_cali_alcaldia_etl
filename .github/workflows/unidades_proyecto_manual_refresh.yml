name: ðŸ”„ Unidades Proyecto - Manual Refresh

on:
  # EjecuciÃ³n manual con opciones especÃ­ficas
  workflow_dispatch:
    inputs:
      force_full_sync:
        description: "Forzar sincronizaciÃ³n completa (ignorar incremental)"
        required: false
        default: false
        type: boolean

      test_mode:
        description: "Modo prueba (solo verificar conexiones)"
        required: false
        default: false
        type: boolean

      debug_mode:
        description: "Activar logs detallados"
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: "3.12"

# Permisos necesarios para Workload Identity Federation
permissions:
  contents: read
  id-token: write

jobs:
  unidades-proyecto-refresh:
    name: ðŸ—ï¸ Refresh Unidades de Proyecto
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ” Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: â˜ï¸ Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: ðŸ” Verify Google Cloud Authentication
        run: |
          echo "ðŸ” Verificando autenticaciÃ³n..."
          gcloud auth list
          gcloud config list
          echo "âœ… AutenticaciÃ³n verificada"

      - name: âš™ï¸ Configure Service Account Permissions
        run: |
          echo "âš™ï¸ Configurando permisos automÃ¡ticamente..."

          # Variables
          PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
          SERVICE_ACCOUNT="${{ secrets.WIF_SERVICE_ACCOUNT }}"

          echo "ðŸ“‹ Project: $PROJECT_ID"
          echo "ðŸ” Service Account: $SERVICE_ACCOUNT"

          # FunciÃ³n para verificar y aplicar permisos
          apply_permission() {
            local role=$1
            local description=$2
            echo "ðŸ”§ Aplicando $description ($role)..."
            
            if gcloud projects add-iam-policy-binding "$PROJECT_ID" \
              --member="serviceAccount:$SERVICE_ACCOUNT" \
              --role="$role" \
              --quiet > /dev/null 2>&1; then
              echo "âœ… $description aplicado correctamente"
            else
              echo "âš ï¸ $description ya existe o error aplicando"
            fi
          }

          # FunciÃ³n para aplicar permisos de service account
          apply_sa_permission() {
            local role=$1
            local member=$2
            local description=$3
            echo "ðŸ”§ Aplicando $description ($role)..."
            
            if gcloud iam service-accounts add-iam-policy-binding "$SERVICE_ACCOUNT" \
              --role="$role" \
              --member="$member" \
              --project="$PROJECT_ID" \
              --quiet > /dev/null 2>&1; then
              echo "âœ… $description aplicado correctamente"
            else
              echo "âš ï¸ $description ya existe o error aplicando"
            fi
          }

          # Obtener project number para WIF
          PROJECT_NUMBER=$(gcloud projects describe "$PROJECT_ID" --format="value(projectNumber)")

          # Aplicar permisos del proyecto
          apply_permission "roles/iam.serviceAccountTokenCreator" "Token Creator"
          apply_permission "roles/iam.serviceAccountUser" "Service Account User"
          apply_permission "roles/datastore.owner" "Firestore Admin"
          apply_permission "roles/firebase.admin" "Firebase Admin"

          # Aplicar auto-impersonaciÃ³n
          apply_sa_permission "roles/iam.serviceAccountTokenCreator" "serviceAccount:$SERVICE_ACCOUNT" "Auto-impersonaciÃ³n"

          # Aplicar Workload Identity binding
          WIF_MEMBER="principalSet://iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/attribute.repository/Juanpgm/proyectos_cali_alcaldia_etl"
          apply_sa_permission "roles/iam.workloadIdentityUser" "$WIF_MEMBER" "Workload Identity"

          echo "ðŸŽ‰ ConfiguraciÃ³n de permisos completada"

      - name: ðŸ”§ Setup Sheets Service Account
        run: |
          echo '${{ secrets.SHEETS_SERVICE_ACCOUNT_JSON }}' > sheets-service-account.json
          chmod 600 sheets-service-account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$(pwd)/sheets-service-account.json" >> $GITHUB_ENV

      - name: ðŸš€ Execute Unidades Proyecto Pipeline
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          GOOGLE_CLOUD_PROJECT: ${{ secrets.FIREBASE_PROJECT_ID }}
          SHEETS_UNIDADES_PROYECTO_URL: ${{ secrets.SHEETS_UNIDADES_PROYECTO_URL }}
          SHEETS_UNIDADES_PROYECTO_WORKSHEET: ${{ secrets.SHEETS_UNIDADES_PROYECTO_WORKSHEET }}
          SHEETS_SERVICE_ACCOUNT_FILE: ./sheets-service-account.json
          FORCE_FULL_SYNC: ${{ github.event.inputs.force_full_sync }}
          TEST_MODE: ${{ github.event.inputs.test_mode }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
        run: |
          echo "ðŸš€ Iniciando refresh de Unidades de Proyecto"
          echo "ðŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ§ª Test Mode: $TEST_MODE"
          echo "ðŸ”„ Force Full Sync: $FORCE_FULL_SYNC"
          echo "ðŸ› Debug Mode: $DEBUG_MODE"
          echo "================================================================================"

          # Crear script de ejecuciÃ³n
          cat > run_refresh.py << 'EOF'
          #!/usr/bin/env python3
          """
          Script de refresh manual para Unidades de Proyecto
          """
          import os
          import sys
          from datetime import datetime

          # Agregar path del proyecto
          sys.path.append('.')

          def test_connections():
              """Prueba las conexiones necesarias."""
              print("ðŸ”— Probando conexiones...")
              
              try:
                  import os
                  # Configurar logging para GitHub Actions
                  os.environ.setdefault('SECURE_LOGGING', 'false')
                  
                  from database.config import test_connection, test_sheets_connection
                  
                  # Test Firebase con mejor manejo de errores
                  print("ðŸ”¥ Probando conexiÃ³n a Firebase...")
                  try:
                      firebase_ok = test_connection()
                      if firebase_ok:
                          print("ðŸ”¥ Firebase: âœ… OK")
                      else:
                          print("ðŸ”¥ Firebase: âŒ FAIL")
                  except Exception as firebase_error:
                      print(f"ðŸ”¥ Firebase: âŒ ERROR - {firebase_error}")
                      firebase_ok = False
                  
                  # Test Google Sheets
                  print("ðŸ“Š Probando conexiÃ³n a Google Sheets...")
                  try:
                      sheets_ok = test_sheets_connection()
                      if sheets_ok:
                          print("ðŸ“Š Sheets: âœ… OK")
                      else:
                          print("ðŸ“Š Sheets: âŒ FAIL")
                  except Exception as sheets_error:
                      print(f"ðŸ“Š Sheets: âŒ ERROR - {sheets_error}")
                      sheets_ok = False
                  
                  # Resultado final
                  if firebase_ok and sheets_ok:
                      print("âœ… Todas las conexiones OK")
                      return True
                  else:
                      print("âŒ Algunas conexiones fallaron")
                      return False
                  
              except Exception as e:
                  print(f"âŒ Error general probando conexiones: {e}")
                  import traceback
                  traceback.print_exc()
                  return False

          def run_pipeline():
              """Ejecuta el pipeline de unidades de proyecto."""
              print("ðŸ—ï¸ Ejecutando pipeline de Unidades de Proyecto...")
              
              try:
                  # Configurar variables de entorno si es necesario
                  if os.getenv('FORCE_FULL_SYNC', 'false').lower() == 'true':
                      os.environ['SKIP_INCREMENTAL_CHECK'] = 'true'
                      print("ðŸ”„ Forzando sincronizaciÃ³n completa")
                  
                  if os.getenv('DEBUG_MODE', 'false').lower() == 'true':
                      os.environ['SECURE_LOGGING'] = 'false'
                      print("ðŸ› Modo debug activado")
                  
                  # Importar y ejecutar pipeline (nueva versiÃ³n sin archivos temporales)
                  from pipelines.unidades_proyecto_inmemory_pipeline import run_inmemory_pipeline
                  
                  # Usar el pipeline en memoria que no requiere archivos temporales
                  success = run_inmemory_pipeline()
                  
                  if success:
                      print("âœ… Pipeline ejecutado exitosamente")
                  else:
                      print("âŒ Pipeline fallÃ³")
                      
                  return success
                  
              except Exception as e:
                  print(f"ðŸ’¥ Error ejecutando pipeline: {e}")
                  if os.getenv('DEBUG_MODE', 'false').lower() == 'true':
                      import traceback
                      traceback.print_exc()
                  return False

          def main():
              """FunciÃ³n principal."""
              test_mode = os.getenv('TEST_MODE', 'false').lower() == 'true'
              
              print(f"ðŸŽ¯ Iniciando refresh - Modo: {'TEST' if test_mode else 'PRODUCCIÃ“N'}")
              print(f"ðŸ“… Timestamp: {datetime.now().isoformat()}")
              
              try:
                  if test_mode:
                      print("ðŸ§ª MODO PRUEBA - Solo verificando conexiones")
                      success = test_connections()
                      
                      if success:
                          print("âœ… Todas las conexiones funcionan correctamente")
                          print("ðŸŽ‰ Test completado exitosamente")
                      else:
                          print("âŒ Algunas conexiones fallaron")
                          sys.exit(1)
                  else:
                      # Primero probar conexiones
                      if not test_connections():
                          print("âŒ Fallo en conexiones iniciales")
                          sys.exit(1)
                      
                      # Ejecutar pipeline
                      success = run_pipeline()
                      
                      if success:
                          print("ðŸŽ‰ Refresh completado exitosamente")
                      else:
                          print("âŒ Refresh fallÃ³")
                          sys.exit(1)
                  
              except Exception as e:
                  print(f"ðŸ’¥ Error general: {e}")
                  sys.exit(1)

          if __name__ == '__main__':
              main()
          EOF

          # Ejecutar script
          python run_refresh.py

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          rm -f sheets-service-account.json
          rm -f run_refresh.py

      - name: ðŸ“Š Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unidades-proyecto-refresh-logs-${{ github.run_number }}
          path: |
            *.log
          retention-days: 7

      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ðŸŽ‰ Refresh de Unidades de Proyecto completado exitosamente"
          echo "ðŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ”— Ver detalles: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "âŒ Refresh de Unidades de Proyecto fallÃ³"
          echo "ðŸ“… Timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ”— Ver detalles: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
