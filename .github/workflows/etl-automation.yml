name: ETL Data Processing Automation

on:
  # EjecuciÃ³n automÃ¡tica diaria a las 2 AM UTC (10 PM hora de Cali)
  schedule:
    - cron: "0 2 * * *"

  # Trigger manual desde GitHub UI
  workflow_dispatch:
    inputs:
      data_types:
        description: 'Data types to process (comma-separated or "all")'
        required: false
        default: "all"
      clear_existing:
        description: "Clear existing data before loading"
        type: boolean
        required: false
        default: false
      force_extraction:
        description: "Force re-extraction even if recent data exists"
        type: boolean
        required: false
        default: false

  # Trigger on push to main branch (opcional - solo para testing)
  push:
    branches: [main]
    paths:
      - "extraction_app/**"
      - "transformation_app/**"
      - "load_app/**"
      - ".github/workflows/**"

env:
  PYTHON_VERSION: "3.12"
  TZ: "America/Bogota"

jobs:
  health-check:
    name: Health Check and Prerequisites
    runs-on: ubuntu-latest
    outputs:
      database_healthy: ${{ steps.db-check.outputs.healthy }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install core dependencies
        run: |
          pip install --upgrade pip
          pip install psycopg2-binary python-dotenv sqlalchemy

      - name: Test database connection
        id: db-check
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: |
          # Test database connection using Python
          python3 -c "
          import os
          import psycopg2

          try:
              database_url = os.getenv('DATABASE_URL')
              if not database_url:
                  print('âŒ DATABASE_URL not configured')
                  exit(1)
              
              conn = psycopg2.connect(database_url)
              cursor = conn.cursor()
              cursor.execute('SELECT version();')
              version = cursor.fetchone()[0]
              
              cursor.close()
              conn.close()
              
              print(f'âœ… Database connection successful: {version[:50]}...')
              print('Connection test passed')
              
          except Exception as e:
              print(f'âŒ Database connection failed: {e}')
              exit(1)
          "

          # Set output using shell command (more reliable)
          if [ $? -eq 0 ]; then
            echo "healthy=true" >> $GITHUB_OUTPUT
          else
            echo "healthy=false" >> $GITHUB_OUTPUT
          fi

  data-extraction:
    name: Data Extraction
    runs-on: ubuntu-latest
    needs: health-check
    if: needs.health-check.outputs.database_healthy == 'true'

    strategy:
      matrix:
        extraction_type:
          - "dacp_sheets"
          - "emprestito_data"
          - "paa_dacp"
          - "unidades_proyecto"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup Chrome for Selenium
        uses: browser-actions/setup-chrome@latest
        if: matrix.extraction_type == 'dacp_sheets'

      - name: Run extraction - ${{ matrix.extraction_type }}
        env:
          FORCE_EXTRACTION: ${{ github.event.inputs.force_extraction || 'false' }}
        run: |
          case "${{ matrix.extraction_type }}" in
            "dacp_sheets")
              echo "ðŸ”„ Extracting DACP contracting data..."
              python extraction_app/data_extraction_contracting_dacp_sheets.py
              ;;
            "emprestito_data")
              echo "ðŸ”„ Extracting emprestito data..."
              python extraction_app/data_extraction_contratos_emprestito.py
              python extraction_app/data_extraction_procesos_emprestito.py
              ;;
            "paa_dacp")
              echo "ðŸ”„ Extracting PAA DACP data..."
              python extraction_app/data_extraction_paa_dacp_sheet.py
              ;;
            "unidades_proyecto")
              echo "ðŸ”„ Extracting unidades proyecto data..."
              python extraction_app/data_extraction_unidades_proyecto_equipamientos.py
              ;;
          esac

      - name: Upload extraction artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extraction-results-${{ matrix.extraction_type }}
          path: |
            extraction_app/outputs/
            transformation_app/app_inputs/
          retention-days: 7

  data-transformation:
    name: Data Transformation
    runs-on: ubuntu-latest
    needs: [health-check, data-extraction]
    if: needs.health-check.outputs.database_healthy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download extraction artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: extraction-results-*
          merge-multiple: true

      - name: Run all transformations
        run: |
          echo "ðŸ”„ Running data transformations..."

          echo "ðŸ“Š Transforming contracts DACP..."
          python transformation_app/data_transformation_contracts_dacp.py

          echo "ðŸ“Š Transforming SECOP contracts..."
          python transformation_app/data_transformation_contratos_secop.py

          echo "ðŸ“Š Transforming budget execution..."
          python transformation_app/data_transformation_ejecucion_presupuestal.py

          echo "ðŸ“Š Transforming PAA DACP..."
          python transformation_app/data_transformation_paa_dacp.py

          echo "ðŸ“Š Transforming SECOP processes..."
          python transformation_app/data_transformation_procesos_secop.py

          echo "ðŸ“Š Transforming project units..."
          python transformation_app/data_transformation_unidades_proyecto.py

          echo "ðŸ“Š Transforming gravity centers..."
          python transformation_app/data_trasnformation_centros_gravedad.py

          echo "âœ… All transformations completed"

      - name: Upload transformation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: transformation-results
          path: transformation_app/app_outputs/
          retention-days: 7

  data-loading:
    name: Data Loading to Railway PostgreSQL
    runs-on: ubuntu-latest
    needs: [health-check, data-transformation]
    if: needs.health-check.outputs.database_healthy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download transformation artifacts
        uses: actions/download-artifact@v4
        with:
          name: transformation-results
          path: transformation_app/app_outputs/

      - name: Load data to Railway PostgreSQL
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: |
          echo "ðŸš‚ Loading data to Railway PostgreSQL..."

          DATA_TYPES="${{ github.event.inputs.data_types || 'all' }}"
          CLEAR_EXISTING="${{ github.event.inputs.clear_existing || 'false' }}"

          if [ "$CLEAR_EXISTING" = "true" ]; then
            echo "ðŸ—‘ï¸ Clearing existing data..."
            python load_app/bulk_load_data.py --data-type "$DATA_TYPES" --clear
          else
            echo "ðŸ“¤ Loading data (append mode)..."
            python load_app/bulk_load_data.py --data-type "$DATA_TYPES"
          fi

          echo "âœ… Data loading completed"

      - name: Verify data loading
        env:
          DATABASE_URL: ${{ secrets.RAILWAY_DATABASE_URL }}
        run: |
          echo "ðŸ” Verifying data in Railway database..."
          python -c "
          import os
          import psycopg2
          from datetime import datetime

          conn = psycopg2.connect(os.getenv('DATABASE_URL'))
          cursor = conn.cursor()

          # Check table record counts
          tables = [
              'unidades_proyecto',
              'datos_caracteristicos_proyectos',
              'ejecucion_presupuestal',
              'movimientos_presupuestales',
              'procesos_contratacion_dacp',
              'ordenes_compra_dacp',
              'paa_dacp',
              'emp_paa_dacp'
          ]

          print(f'ðŸ“Š Database verification - {datetime.now()}')
          print('=' * 50)

          total_records = 0
          for table in tables:
              try:
                  cursor.execute(f'SELECT COUNT(*) FROM {table};')
                  count = cursor.fetchone()[0]
                  total_records += count
                  status = 'âœ…' if count > 0 else 'âš ï¸'
                  print(f'{status} {table}: {count:,} records')
              except Exception as e:
                  print(f'âŒ {table}: Error - {e}')

          print('=' * 50)
          print(f'ðŸ“ˆ Total records across all tables: {total_records:,}')

          cursor.close()
          conn.close()
          "

  notification:
    name: Send Completion Notification
    runs-on: ubuntu-latest
    needs: [health-check, data-loading]
    if: always()

    steps:
      - name: Determine status
        run: |
          if [ "${{ needs.health-check.result }}" = "success" ] && [ "${{ needs.data-loading.result }}" = "success" ]; then
            echo "WORKFLOW_STATUS=success" >> $GITHUB_ENV
            echo "STATUS_EMOJI=âœ…" >> $GITHUB_ENV
            echo "STATUS_MESSAGE=ETL process completed successfully" >> $GITHUB_ENV
          else
            echo "WORKFLOW_STATUS=failure" >> $GITHUB_ENV
            echo "STATUS_EMOJI=âŒ" >> $GITHUB_ENV
            echo "STATUS_MESSAGE=ETL process failed" >> $GITHUB_ENV
          fi

      - name: Log completion status
        run: |
          echo "${{ env.STATUS_EMOJI }} ${{ env.STATUS_MESSAGE }}"
          echo "Timestamp: $(date)"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual parameters:"
            echo "  Data types: ${{ github.event.inputs.data_types || 'all' }}"
            echo "  Clear existing: ${{ github.event.inputs.clear_existing || 'false' }}"
            echo "  Force extraction: ${{ github.event.inputs.force_extraction || 'false' }}"
          fi
