-- ==============================================\n-- VISTAS MATERIALIZADAS PARA ANALYTICS\n-- ==============================================\n\n-- Vista resumen de proyectos\nCREATE MATERIALIZED VIEW IF NOT EXISTS analytics.resumen_proyectos AS\nSELECT\n    COUNT(*) as total_proyectos,\n    SUM(CASE WHEN is_active THEN 1 ELSE 0 END) as proyectos_activos,\n    EXTRACT(YEAR FROM created_at) as año,\n    EXTRACT(MONTH FROM created_at) as mes\nFROM datos_caracteristicos_proyectos\nGROUP BY EXTRACT(YEAR FROM created_at), EXTRACT(MONTH FROM created_at);\n\nCREATE UNIQUE INDEX IF NOT EXISTS idx_resumen_proyectos_año_mes\n    ON analytics.resumen_proyectos (año, mes);\n\n-- Vista resumen de contratos\nCREATE MATERIALIZED VIEW IF NOT EXISTS analytics.resumen_contratos AS\nSELECT\n    COUNT(*) as total_contratos,\n    SUM(valor_contrato) as valor_total,\n    AVG(valor_contrato) as valor_promedio,\n    estado_contrato,\n    DATE_TRUNC('month', created_at) as periodo\nFROM contratos_proyectos\nWHERE is_active = true\nGROUP BY estado_contrato, DATE_TRUNC('month', created_at);\n\nCREATE INDEX IF NOT EXISTS idx_resumen_contratos_estado_periodo\n    ON analytics.resumen_contratos (estado_contrato, periodo);\n\n-- Función para refrescar todas las vistas materializadas\nCREATE OR REPLACE FUNCTION analytics.refresh_all_views()\nRETURNS void AS $$\nBEGIN\n    REFRESH MATERIALIZED VIEW CONCURRENTLY analytics.resumen_proyectos;\n    REFRESH MATERIALIZED VIEW CONCURRENTLY analytics.resumen_contratos;\n    \n    -- Log de actualización\n    INSERT INTO historical.change_log (table_name, operation, changed_by, changed_at)\n    VALUES ('analytics_views', 'REFRESH', current_user, CURRENT_TIMESTAMP);\nEND;\n$$ LANGUAGE plpgsql;\n