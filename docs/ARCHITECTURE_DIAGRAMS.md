# ğŸ“ Diagramas de Arquitectura - Pipeline Serverless

## ğŸ¯ Vista General del Sistema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          PIPELINE ETL SERVERLESS                          â”‚
â”‚                      Unidades de Proyecto - Cali                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Sheets  â”‚  â† Fuente de datos original
â”‚   (Drive API)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (1) EXTRACCIÃ“N LOCAL
         â”‚ extraction_app/data_extraction_unidades_proyecto.py
         â”‚ â€¢ AutenticaciÃ³n OAuth2
         â”‚ â€¢ Descarga hojas especÃ­ficas
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GeoJSON Raw    â”‚  â† Archivo local temporal
â”‚  (context/)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (2) TRANSFORMACIÃ“N LOCAL
         â”‚ transformation_app/data_transformation_unidades_proyecto.py
         â”‚ â€¢ ValidaciÃ³n de coordenadas
         â”‚ â€¢ GeocodificaciÃ³n (Google Maps API)
         â”‚ â€¢ IntersecciÃ³n espacial con basemaps
         â”‚ â€¢ NormalizaciÃ³n de campos
         â”‚ â€¢ GeneraciÃ³n logs y reports
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app_outputs/    â”‚  â† Archivos transformados locales
â”‚ â”œâ”€â”€ *.geojson   â”‚
â”‚ â”œâ”€â”€ logs/       â”‚
â”‚ â””â”€â”€ reports/    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ (3) UPLOAD A S3 (AUTOMÃTICO)
         â”‚ utils/s3_uploader.py
         â”‚ â€¢ Credenciales desde aws_credentials.json
         â”‚ â€¢ Upload multi-folder
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            AWS S3 BUCKET                                   â”‚
â”‚         unidades-proyecto-documents                        â”‚
â”‚                                                            â”‚
â”‚  /up-geodata/                                              â”‚
â”‚    â””â”€â”€ unidades_proyecto_transformed.geojson (1,641 feat) â”‚
â”‚                                                            â”‚
â”‚  /logs/                                                    â”‚
â”‚    â””â”€â”€ transformation_log_YYYYMMDD_HHMMSS.json            â”‚
â”‚                                                            â”‚
â”‚  /reports/                                                 â”‚
â”‚    â””â”€â”€ transformation_report_YYYYMMDD_HHMMSS.json         â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â”‚  TRIGGERS (3 OPCIONES):           â”‚
        â”‚                 â”‚                 â”‚
        â”‚  A) Manual:     â”‚ HTTP POST       â”‚
        â”‚  B) Scheduler:  â”‚ Diario 2 AM     â”‚
        â”‚  C) Pipeline:   â”‚ Env var         â”‚
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ (4) CLOUD FUNCTION (SERVERLESS)
                          â”‚ load_unidades_proyecto_from_s3()
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          GOOGLE CLOUD FUNCTION (Gen 2)                     â”‚
â”‚          Runtime: Python 3.11                              â”‚
â”‚          Memory: 512MB | Timeout: 540s                     â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ main.py                                      â”‚         â”‚
â”‚  â”‚  â€¢ Inicializa handlers                       â”‚         â”‚
â”‚  â”‚  â€¢ Orquesta flujo de datos                   â”‚         â”‚
â”‚  â”‚  â€¢ Manejo de errores                         â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                       â”‚                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚                    â”‚                         â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚         â”‚
â”‚  â”‚  â”‚ S3Handler (utils.py)           â”‚          â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ Credenciales desde Secret   â”‚          â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ read_json_from_s3()         â”‚          â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ list_files()                â”‚          â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚         â”‚
â”‚  â”‚               â”‚                              â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚         â”‚
â”‚  â”‚  â”‚ DataTransformer (utils.py)    â”‚           â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ Mapeo de campos            â”‚           â”‚         â”‚
â”‚  â”‚  â”‚    - comuna_corregimiento_2   â”‚           â”‚         â”‚
â”‚  â”‚  â”‚    - barrio_vereda_2          â”‚           â”‚         â”‚
â”‚  â”‚  â”‚    - fecha_*_std â†’ fecha_*    â”‚           â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ GeometrÃ­a â†’ GeoPoint       â”‚           â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ ValidaciÃ³n de datos        â”‚           â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚         â”‚
â”‚  â”‚               â”‚                              â”‚         â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚         â”‚
â”‚  â”‚  â”‚ FirestoreHandler (utils.py)   â”‚           â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ get_existing_documents()   â”‚           â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ upsert_document()          â”‚           â”‚         â”‚
â”‚  â”‚  â”‚    - Calcula MD5 hash         â”‚           â”‚         â”‚
â”‚  â”‚  â”‚    - Compara con existente    â”‚           â”‚         â”‚
â”‚  â”‚  â”‚    - Solo escribe si cambiÃ³   â”‚           â”‚         â”‚
â”‚  â”‚  â”‚  â€¢ batch_upsert() (500 docs)  â”‚           â”‚         â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                            â”‚
â”‚  ConfiguraciÃ³n:                                            â”‚
â”‚  â€¢ S3_BUCKET_NAME = "unidades-proyecto-documents"         â”‚
â”‚  â€¢ AWS_CREDENTIALS_SECRET = "projects/.../aws-creds"      â”‚
â”‚  â€¢ SERVICE_ACCOUNT = cloud-functions-etl@...              â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ (5) UPSERT INTELIGENTE
                          â”‚ â€¢ Nuevos: INSERT
                          â”‚ â€¢ Existentes sin cambios: SKIP
                          â”‚ â€¢ Existentes con cambios: UPDATE
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               FIREBASE FIRESTORE                           â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ unidades_proyecto                            â”‚         â”‚
â”‚  â”‚  Document ID: upid                           â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ upid                                    â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ nombre_proyecto                         â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ comuna_corregimiento (mapped from _2)  â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ barrio_vereda (prioritizes _2)         â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ fecha_inicio (from fecha_inicio_std)   â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ fecha_fin (from fecha_fin_std)         â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ geometry (GeoPoint or polygon)         â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ ... (65 campos totales)                â”‚         â”‚
â”‚  â”‚  â””â”€â”€ _metadata                               â”‚         â”‚
â”‚  â”‚      â”œâ”€â”€ hash (MD5)                          â”‚         â”‚
â”‚  â”‚      â””â”€â”€ last_updated                        â”‚         â”‚
â”‚  â”‚                                              â”‚         â”‚
â”‚  â”‚  Total: ~1,641 documents                     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ unidades_proyecto_transformation_logs        â”‚         â”‚
â”‚  â”‚  Document ID: log filename                   â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ timestamp                               â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ records_processed                       â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ success                                 â”‚         â”‚
â”‚  â”‚  â””â”€â”€ ...                                     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ unidades_proyecto_transformation_reports     â”‚         â”‚
â”‚  â”‚  Document ID: report filename                â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ quality_metrics                         â”‚         â”‚
â”‚  â”‚  â”œâ”€â”€ validation_results                      â”‚         â”‚
â”‚  â”‚  â””â”€â”€ ...                                     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Flujo de Credenciales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GESTIÃ“N DE CREDENCIALES                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AWS CLI Config   â”‚  â† Usuario local con permisos S3
â”‚ ~/.aws/config    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ setup_aws_quick.ps1 (extrae credenciales)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ aws_credentials.json â”‚  â† Local, gitignored
â”‚  {                   â”‚
â”‚    aws_access_key_id â”‚
â”‚    aws_secret_...    â”‚
â”‚    region            â”‚
â”‚  }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                 â”‚
         â”‚ (LOCAL)                         â”‚ (GCP)
         â”‚ utils/s3_uploader.py            â”‚ setup_cloud_functions.ps1
         â”‚ Lee directamente                â”‚ Sube a Secret Manager
         â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ S3 Upload        â”‚            â”‚ GCP Secret Manager      â”‚
â”‚ (desde local)    â”‚            â”‚ projects/.../secrets/   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ aws-credentials         â”‚
                                â”‚  {                      â”‚
                                â”‚    aws_access_key_id    â”‚
                                â”‚    aws_secret_...       â”‚
                                â”‚    region               â”‚
                                â”‚  }                      â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â”‚ IAM Policy:
                                           â”‚ secretAccessor
                                           â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ Service Account         â”‚
                                â”‚ cloud-functions-etl@... â”‚
                                â”‚                         â”‚
                                â”‚ Permissions:            â”‚
                                â”‚ â€¢ secretAccessor        â”‚
                                â”‚ â€¢ datastore.user        â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
                                           â”‚ Usado por
                                           â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ Cloud Function          â”‚
                                â”‚ â€¢ Lee secret            â”‚
                                â”‚ â€¢ Accede S3             â”‚
                                â”‚ â€¢ Escribe Firestore     â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âš™ï¸ Diagrama de Upsert Inteligente

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            LÃ“GICA DE UPSERT CON MD5 HASH                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Para cada documento en GeoJSON:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Documento de S3     â”‚
â”‚ {                   â”‚
â”‚   upid: "UP-123",   â”‚
â”‚   nombre: "...",    â”‚
â”‚   ...               â”‚
â”‚ }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (1) Transformar campos
           â”‚     â€¢ comuna_corregimiento_2 â†’ comuna_corregimiento
           â”‚     â€¢ barrio_vereda_2 â†’ barrio_vereda
           â”‚     â€¢ fecha_*_std â†’ fecha_*
           â”‚     â€¢ geometry â†’ GeoPoint
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Documento           â”‚
â”‚ transformado        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (2) Calcular MD5 hash
           â”‚     hash = md5(JSON.stringify(doc))
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Hash: "a3f2e9..."   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ (3) Buscar en Firestore
           â”‚     doc_ref = db.collection('...').document(upid)
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Â¿Existe documento?                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚             â”‚
      NO   â”‚             â”‚ SÃ
           â”‚             â”‚
           â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ INSERT       â”‚  â”‚ Â¿Hash diferente?     â”‚
â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â€¢ Agregar    â”‚         â”‚       â”‚
â”‚   _metadata  â”‚    SÃ   â”‚       â”‚ NO
â”‚ â€¢ hash       â”‚         â”‚       â”‚
â”‚ â€¢ timestamp  â”‚         â–¼       â–¼
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ doc_ref.set()â”‚  â”‚ UPDATE   â”‚  â”‚ SKIP     â”‚
â”‚              â”‚  â”‚          â”‚  â”‚          â”‚
â”‚ return 'new' â”‚  â”‚ â€¢ Update â”‚  â”‚ No escribeâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   doc    â”‚  â”‚          â”‚
                  â”‚ â€¢ Update â”‚  â”‚ return   â”‚
                  â”‚   hash   â”‚  â”‚ 'unchanged'
                  â”‚ â€¢ Update â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚   timestamp
                  â”‚          â”‚
                  â”‚ doc_ref. â”‚
                  â”‚ set()    â”‚
                  â”‚          â”‚
                  â”‚ return   â”‚
                  â”‚ 'updated'â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Batch Upsert (500 docs):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for batch in chunks(documents, 500):     â”‚
â”‚   for doc in batch:                      â”‚
â”‚     result = upsert_document(doc)        â”‚
â”‚     stats[result] += 1                   â”‚
â”‚                                          â”‚
â”‚ return {                                 â”‚
â”‚   'new': count,                          â”‚
â”‚   'updated': count,                      â”‚
â”‚   'unchanged': count                     â”‚
â”‚ }                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š Diagrama de Datos - Mapeo de Campos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MAPEO DE CAMPOS                                 â”‚
â”‚               (GeoJSON S3 â†’ Firestore)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Campo: comuna_corregimiento
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GeoJSON:                              Firestore:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fuera_rango:        â”‚               â”‚ comuna_corregimientoâ”‚
â”‚   "ACEPTABLE"       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ (valor de _2)       â”‚
â”‚ comuna_corregimieto_2â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   "Comuna 5"        â”‚
â”‚ comuna_corregimientoâ”‚
â”‚   "Comuna 3"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fuera_rango:        â”‚               â”‚ comuna_corregimientoâ”‚
â”‚   "FUERA DE RANGO"  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ (valor original)    â”‚
â”‚ comuna_corregimientoâ”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   "Comuna 3"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Campo: barrio_vereda
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GeoJSON:                              Firestore:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ barrio_vereda_2:    â”‚  PRIORIDAD 1  â”‚ barrio_vereda       â”‚
â”‚   "Barrio Nuevo"    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ "Barrio Nuevo"      â”‚
â”‚ barrio_vereda:      â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   "Barrio Viejo"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ barrio_vereda_2:    â”‚  FALLBACK     â”‚ barrio_vereda       â”‚
â”‚   null              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ "Barrio Viejo"      â”‚
â”‚ barrio_vereda:      â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚   "Barrio Viejo"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Campos: Fechas
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GeoJSON:                              Firestore:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fecha_inicio_std:   â”‚  RENOMBRAR    â”‚ fecha_inicio:       â”‚
â”‚   "2024-01-01"      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ "2024-01-01"        â”‚
â”‚                     â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ fecha_fin_std:      â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   "2024-12-31"      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ fecha_fin:          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ "2024-12-31"        â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      (NO se guardan _std)


Campo: GeometrÃ­a
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GeoJSON Point:                        Firestore:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ geometry: {         â”‚  CONVERTIR    â”‚ geometry:           â”‚
â”‚   type: "Point",    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ GeoPoint(           â”‚
â”‚   coordinates: [    â”‚               â”‚   latitude: 3.4516, â”‚
â”‚     -76.5225,       â”‚               â”‚   longitude:-76.5225â”‚
â”‚     3.4516          â”‚               â”‚ )                   â”‚
â”‚   ]                 â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GeoJSON Polygon:                      Firestore:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ geometry: {         â”‚  MANTENER     â”‚ geometry: {         â”‚
â”‚   type: "Polygon",  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   type: "polygon",  â”‚
â”‚   coordinates: [[   â”‚               â”‚   coordinates: [[   â”‚
â”‚     [...],          â”‚               â”‚     [...],          â”‚
â”‚     [...]           â”‚               â”‚     [...]           â”‚
â”‚   ]]                â”‚               â”‚   ]]                â”‚
â”‚ }                   â”‚               â”‚ }                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


Campo: Identificador Ãšnico
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
GeoJSON:                              Firestore:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ properties: {       â”‚               â”‚ Document ID:        â”‚
â”‚   upid: "UP-001234" â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ "UP-001234"         â”‚
â”‚   ...               â”‚               â”‚                     â”‚
â”‚ }                   â”‚               â”‚ Fields:             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   upid: "UP-001234" â”‚
                                      â”‚   ...               â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Diagrama de Triggers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  OPCIONES DE EJECUCIÃ“N                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPCIÃ“N A: TRIGGER MANUAL (HTTP)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Usuario/Script   â”‚
â”‚ PowerShell/curl  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP POST
         â”‚ Invoke-WebRequest -Uri $url
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Function URL:                 â”‚
â”‚ https://REGION-PROJECT.             â”‚
â”‚ cloudfunctions.net/                 â”‚
â”‚ manual-trigger-unidades-proyecto    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Ejecuta
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ load_unidades_proyecto_from_s3()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


OPCIÃ“N B: CLOUD SCHEDULER (AUTOMÃTICO)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Scheduler  â”‚
â”‚ Cron: 0 2 * * *  â”‚  â† Diario 2:00 AM
â”‚ Job: etl-...     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTP POST (automÃ¡tico)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Function URL:                 â”‚
â”‚ https://REGION-PROJECT.             â”‚
â”‚ cloudfunctions.net/                 â”‚
â”‚ load-unidades-proyecto              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Ejecuta
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ load_unidades_proyecto_from_s3()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


OPCIÃ“N C: DESDE PIPELINE (CONDICIONAL)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ python data_transformation_...py    â”‚
â”‚                                      â”‚
â”‚ if __name__ == "__main__":           â”‚
â”‚   # ... transformaciÃ³n ...           â”‚
â”‚   # ... upload S3 ...                â”‚
â”‚                                      â”‚
â”‚   if TRIGGER_CLOUD_FUNCTION:         â”‚
â”‚     requests.post(                   â”‚
â”‚       CLOUD_FUNCTION_URL,            â”‚
â”‚       timeout=600                    â”‚
â”‚     )                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ Condicional (env var)
         â”‚ $env:TRIGGER_CLOUD_FUNCTION = "true"
         â”‚ $env:CLOUD_FUNCTION_URL = "https://..."
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Function                       â”‚
â”‚ Ejecuta si variables configuradas    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


RESUMEN:
â”€â”€â”€â”€â”€â”€â”€â”€
A) Manual:    Usuario decide cuÃ¡ndo ejecutar
B) Scheduler: EjecuciÃ³n automÃ¡tica programada
C) Pipeline:  AutomÃ¡tico despuÃ©s de transformaciÃ³n (opcional)
```

## ğŸ’° Diagrama de Costos

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     COSTOS MENSUALES                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GOOGLE CLOUD PLATFORM
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Cloud Functions (Gen 2):
  â€¢ Invocaciones:  30/mes (1 diaria)    â†’ Gratis (2M gratis/mes)
  â€¢ Compute:       512MB x 30s x 30     â†’ ~$0.075/mes
  â€¢ Networking:    Egress mÃ­nimo        â†’ ~$0.00/mes
                                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Subtotal GCP Functions:                  $0.075/mes

Secret Manager:
  â€¢ Secrets activos: 1                  â†’ Gratis (6 gratis)
  â€¢ Accesos: ~30/mes                    â†’ Gratis (10K gratis/mes)
                                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Subtotal Secret Manager:                 $0.00/mes

Firestore:
  â€¢ Documentos: ~1,641                  â†’ Storage gratis (<1GB)
  â€¢ Reads: ~1,641/dÃ­a                   â†’ Gratis (50K gratis/dÃ­a)
  â€¢ Writes: ~50/dÃ­a (con upsert)        â†’ Gratis (20K gratis/dÃ­a)
                                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Subtotal Firestore:                      $0.00/mes

Cloud Scheduler:
  â€¢ Jobs: 1                             â†’ Gratis (3 gratis)
                                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Subtotal Scheduler:                      $0.00/mes

                                Total GCP: ~$0.08/mes


AMAZON WEB SERVICES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

S3 Storage:
  â€¢ Bucket: unidades-proyecto-documents
  â€¢ Size: ~500MB                        â†’ $0.023/GB = $0.012/mes
  â€¢ Objects: ~4 archivos                â†’ Gratis

S3 Requests:
  â€¢ PUT: ~3/dÃ­a x 30 = 90              â†’ Gratis (2K gratis/mes)
  â€¢ GET: ~3/dÃ­a x 30 = 90              â†’ Gratis (2K gratis/mes)
                                           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Subtotal S3:                             $0.012/mes

                                Total AWS: ~$0.01/mes

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TOTAL MENSUAL:                             ~$0.09/mes (~$1.08/aÃ±o)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

NOTA: Costos asumen:
  â€¢ 1 ejecuciÃ³n diaria
  â€¢ ~1,641 documentos
  â€¢ ~50 cambios por dÃ­a (3% change rate con upsert inteligente)
  â€¢ 512MB Cloud Function
  â€¢ 30s execution time

Para mayor volumen:
  â€¢ 10 ejecuciones diarias: ~$0.75/mes
  â€¢ 10,000 documentos: ~$0.15/mes (Firestore)
  â€¢ 5GB S3: ~$0.12/mes
```

---

**DocumentaciÃ³n completa en:**

- `docs/SERVERLESS_PIPELINE_GUIDE.md`
- `cloud_functions/README.md`
- `IMPLEMENTATION_SUMMARY.md`
